/* eslint-disable */
/// <reference types="cypress" />
import { generateLatinUsername } from '../support/utils';


const username = generateLatinUsername();
const password = 'GoodP@ss123456#Aa';
const fileA = 'sample_19m57s.mp3';
const fileB = 'sample_ru_120s.mp3';
const taskA = 1;
const taskB = 2;
const apiUrl = Cypress.env('apiUrl');
const adminToken = Cypress.env('admin_secret_token');
const now = new Date();
const isoNow = now.toISOString();
const isoEarlier = new Date(now.getTime() - 5 * 60000).toISOString(); // 5 –º–∏–Ω –Ω–∞–∑–∞–¥

const chunksA = [
  {
    chunk_order: 0,
    chunk_size_secs: 900,
    id: 1,
    transcription: `–¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏. –î–∞–ª—å—à–µ —Ç–µ–∫—Å—Ç –∏–∑ –ê–ª–∏—Å—ã –≤ —Å—Ç—Ä–∞–Ω–µ —á—É–¥–µ—Å. –ê–ª–∏—Å–µ –Ω–∞—Å–∫—É—á–∏–ª–æ —Å–∏–¥–µ—Ç—å —Å —Å–µ—Å—Ç—Ä–æ–π –±–µ–∑ –¥–µ–ª–∞ –Ω–∞ –±–µ—Ä–µ–≥—É —Ä–µ–∫–∏; —Ä–∞–∑–æ–∫-–¥—Ä—É–≥–æ–π –æ–Ω–∞ –∑–∞–≥–ª—è–Ω—É–ª–∞ –≤ –∫–Ω–∏–∂–∫—É, –∫–æ—Ç–æ—Ä—É—é —á–∏—Ç–∞–ª–∞ —Å–µ—Å—Ç—Ä–∞, –Ω–æ —Ç–∞–º –Ω–µ –±—ã–ª–æ –Ω–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫, –Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤. - –ß—Ç–æ —Ç–æ–ª–∫—É –≤ –∫–Ω–∏–∂–∫–µ, - –ø–æ–¥—É–º–∞–ª–∞ –ê–ª–∏—Å–∞, - –µ—Å–ª–∏ –≤ –Ω–µ–π –Ω–µ—Ç –Ω–∏ –∫–∞—Ä—Ç–∏–Ω–æ–∫, –Ω–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤? –û–Ω–∞ —Å–∏–¥–µ–ª–∞ –∏ —Ä–∞–∑–º—ã—à–ª—è–ª–∞, –Ω–µ –≤—Å—Ç–∞—Ç—å –ª–∏ –µ–π –∏ –Ω–µ –Ω–∞—Ä–≤–∞—Ç—å –ª–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≤–µ–Ω–∫–∞; –º—ã—Å–ª–∏ –µ–µ —Ç–µ–∫–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–æ –∏ –Ω–µ—Å–≤—è–∑–Ω–æ - –æ—Ç –∂–∞—Ä—ã –µ–µ –∫–ª–æ–Ω–∏–ª–æ –≤ —Å–æ–Ω. –ö–æ–Ω–µ—á–Ω–æ, —Å–ø–ª–µ—Å—Ç–∏ –≤–µ–Ω–æ–∫ –±—ã–ª–æ –±—ã –æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ, –Ω–æ —Å—Ç–æ–∏—Ç –ª–∏ —Ä–∞–¥–∏ —ç—Ç–æ–≥–æ –ø–æ–¥—ã–º–∞—Ç—å—Å—è? –í–¥—Ä—É–≥ –º–∏–º–æ –ø—Ä–æ–±–µ–∂–∞–ª –±–µ–ª—ã–π –∫—Ä–æ–ª–∏–∫ —Å –∫—Ä–∞—Å–Ω—ã–º–∏ –≥–ª–∞–∑–∞–º–∏. –ö–æ–Ω–µ—á–Ω–æ, –Ω–∏—á–µ–≥–æ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤ —ç—Ç–æ–º –Ω–µ –±—ã–ª–æ. –ü—Ä–∞–≤–¥–∞, –ö—Ä–æ–ª–∏–∫ –Ω–∞ –±–µ–≥—É –≥–æ–≤–æ—Ä–∏–ª: - –ê—Ö, –±–æ–∂–µ –º–æ–π, –±–æ–∂–µ –º–æ–π! –Ø –æ–ø–∞–∑–¥—ã–≤–∞—é. –ù–æ –∏ —ç—Ç–æ –Ω–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å –ê–ª–∏—Å–µ –æ—Å–æ–±–µ–Ω–Ω–æ —Å—Ç—Ä–∞–Ω–Ω—ã–º. (–í—Å–ø–æ–º–∏–Ω–∞—è –æ–± —ç—Ç–æ–º –ø–æ–∑–∂–µ, –æ–Ω–∞ –ø–æ–¥—É–º–∞–ª–∞, —á—Ç–æ –µ–π —Å–ª–µ–¥–æ–≤–∞–ª–æ –±—ã —É–¥–∏–≤–∏—Ç—å—Å—è, –æ–¥–Ω–∞–∫–æ –≤ —Ç–æ—Ç –º–∏–≥ –≤—Å–µ –∫–∞–∑–∞–ª–æ—Å—å –µ–π –≤–ø–æ–ª–Ω–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º.) –ù–æ, –∫–æ–≥–¥–∞ –ö—Ä–æ–ª–∏–∫ –≤–¥—Ä—É–≥ –≤—ã–Ω—É–ª —á–∞—Å—ã –∏–∑ –∂–∏–ª–µ—Ç–Ω–æ–≥–æ –∫–∞—Ä–º–∞–Ω–∞ –∏, –≤–∑–≥–ª—è–Ω—É–≤ –Ω–∞ –Ω–∏—Ö, –ø–æ–º—á–∞–ª—Å—è –¥–∞–ª—å—à–µ, –ê–ª–∏—Å–∞ –≤—Å–∫–æ—á–∏–ª–∞ –Ω–∞ –Ω–æ–≥–∏. –ï–µ —Ç—É—Ç –æ—Å–µ–Ω–∏–ª–æ: –≤–µ–¥—å –Ω–∏–∫–æ–≥–¥–∞ —Ä–∞–Ω—å—à–µ –æ–Ω–∞ –Ω–µ –≤–∏–¥–µ–ª–∞ –∫—Ä–æ–ª–∏–∫–∞ —Å —á–∞—Å–∞–º–∏, –¥–∞ –µ—â–µ —Å –∂–∏–ª–µ—Ç–Ω—ã–º –∫–∞—Ä–º–∞–Ω–æ–º –≤ –ø—Ä–∏–¥–∞—á—É! –°–≥–æ—Ä–∞—è –æ—Ç –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–∞, –æ–Ω–∞ –ø–æ–±–µ–∂–∞–ª–∞ –∑–∞ –Ω–∏–º –ø–æ –ø–æ–ª—é –∏ —Ç–æ–ª—å–∫–æ-—Ç–æ–ª—å–∫–æ —É—Å–ø–µ–ª–∞ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –æ–Ω —é—Ä–∫–Ω—É–ª –≤ –Ω–æ—Ä—É –ø–æ–¥ –∏–∑–≥–æ—Ä–æ–¥—å—é. –í —Ç–æ—Ç –∂–µ –º–∏–≥ –ê–ª–∏—Å–∞ —é—Ä–∫–Ω—É–ª–∞ –∑–∞ –Ω–∏–º —Å–ª–µ–¥–æ–º, –Ω–µ –¥—É–º–∞—è –æ —Ç–æ–º, –∫–∞–∫ –∂–µ –æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å—Å—è –æ–±—Ä–∞—Ç–Ω–æ. –ù–æ—Ä–∞ —Å–Ω–∞—á–∞–ª–∞ —à–ª–∞ –ø—Ä—è–º–æ, —Ä–æ–≤–Ω–∞—è, –∫–∞–∫ —Ç—É–Ω–Ω–µ–ª—å, –∞ –ø–æ—Ç–æ–º –≤–¥—Ä—É–≥ –∫—Ä—É—Ç–æ –æ–±—Ä—ã–≤–∞–ª–∞—Å—å –≤–Ω–∏–∑. –ù–µ —É—Å–ø–µ–ª–∞ –ê–ª–∏—Å–∞ –∏ –≥–ª–∞–∑–æ–º –º–æ—Ä–≥–Ω—É—Ç—å, –∫–∞–∫ –æ–Ω–∞ –Ω–∞—á–∞–ª–∞ –ø–∞–¥–∞—Ç—å, —Å–ª–æ–≤–Ω–æ –≤ –≥–ª—É–±–æ–∫–∏–π –∫–æ–ª–æ–¥–µ—Ü. –¢–æ –ª–∏ –∫–æ–ª–æ–¥–µ—Ü –±—ã–ª –æ—á–µ–Ω—å –≥–ª—É–±–æ–∫, —Ç–æ –ª–∏ –ø–∞–¥–∞–ª–∞ –æ–Ω–∞ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ —É –Ω–µ–µ –±—ã–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏–π—Ç–∏ –≤ —Å–µ–±—è –∏ –ø–æ–¥—É–º–∞—Ç—å, —á—Ç–æ –∂–µ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ. –°–Ω–∞—á–∞–ª–∞ –æ–Ω–∞ –ø–æ–ø—ã—Ç–∞–ª–∞—Å—å —Ä–∞–∑–≥–ª—è–¥–µ—Ç—å, —á—Ç–æ –∂–¥–µ—Ç –µ–µ –≤–Ω–∏–∑—É, –Ω–æ —Ç–∞–º –±—ã–ª–æ —Ç–µ–º–Ω–æ, –∏ –æ–Ω–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —É–≤–∏–¥–µ–ª–∞. –¢–æ–≥–¥–∞ –æ–Ω–∞ –ø—Ä–∏–Ω—è–ª–∞—Å—å —Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ —Å—Ç–æ—Ä–æ–Ω–∞–º. –°—Ç–µ–Ω—ã –∫–æ–ª–æ–¥—Ü–∞ –±—ã–ª–∏ —É—Å—Ç–∞–≤–ª–µ–Ω—ã —à–∫–∞—Ñ–∞–º–∏ –∏ –∫–Ω–∏–∂–Ω—ã–º–∏ –ø–æ–ª–∫–∞–º–∏; –∫–æ–µ-–≥–¥–µ –≤–∏—Å–µ–ª–∏ –Ω–∞ –≥–≤–æ–∑–¥–∏–∫–∞—Ö –∫–∞—Ä—Ç–∏–Ω—ã –∏ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–ª–µ—Ç–∞—è –º–∏–º–æ –æ–¥–Ω–æ–π –∏–∑ –ø–æ–ª–æ–∫, –æ–Ω–∞ –ø—Ä–∏—Ö–≤–∞—Ç–∏–ª–∞ —Å –Ω–µ–µ –±–∞–Ω–∫—É —Å –≤–∞—Ä–µ–Ω—å–µ–º. –ù–∞ –±–∞–Ω–∫–µ –±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ ¬´–ê–ü–ï–õ–¨–°–ò–ù–û–í–û–ï¬ª, –Ω–æ —É–≤—ã! –æ–Ω–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å –ø—É—Å—Ç–æ–π. –ê–ª–∏—Å–∞ –ø–æ–±–æ—è–ª–∞—Å—å –±—Ä–æ—Å–∏—Ç—å –±–∞–Ω–∫—É –≤–Ω–∏–∑ - –∫–∞–∫ –±—ã –Ω–µ —É–±–∏—Ç—å –∫–æ–≥–æ-–Ω–∏–±—É–¥—å! –ù–∞ –ª–µ—Ç—É –æ–Ω–∞ —É–º—É–¥—Ä–∏–ª–∞—Å—å –∑–∞—Å—É–Ω—É—Ç—å –µ–µ –≤ –∫–∞–∫–æ–π-—Ç–æ —à–∫–∞—Ñ.`,
  },
  { chunk_order: 1, chunk_size_secs: 100, id: 2, transcription: '–¢–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏.' },
  { chunk_order: 2, chunk_size_secs: 0, id: 3, transcription: null },
];

const chunksB = [
  { chunk_order: 0, chunk_size_secs: 60, id: 5, transcription: '–ß–∞–Ω–∫ 1.' },
  { chunk_order: 1, chunk_size_secs: 60, id: 6, transcription: '–ß–∞–Ω–∫ 2' },
];

describe('4Ô∏è‚É£ –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π + –ø—Ä–æ—Å–º–æ—Ç—Ä —á–∞–Ω–∫–æ–≤', () => {
  let uid;
  let tasks = [];

  const interceptList = (alias = 'list') => {
    cy.intercept('GET', `${apiUrl}/transcriptions?page=1&size=100`, {
      statusCode: 200,
      body: {
        page: 1, pages: 1, size: 100, total: tasks.length,
        transcriptions: tasks,
      },
    }).as(alias);
  };

  before(() => {
    cy.registerAndPrepareUser(username, password).then(id => {
      uid = id;
    });
  });

  it('üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –∏ —á–∞–Ω–∫–æ–≤', function () {
    cy.then(() => {
      tasks = [
        {
          id: taskA,
          creator_id: uid,
          audio_len_secs: 1200,
          chunk_size_secs: 900,
          current_state: 'completed',
          create_date: isoEarlier,
          update_date: isoEarlier,
          description: fileA,
        },
        {
          id: taskB,
          creator_id: uid,
          audio_len_secs: 120,
          chunk_size_secs: 900,
          current_state: 'completed',
          create_date: isoNow,
          update_date: isoNow,
          description: fileB,
        },
      ];
      interceptList('list');
    });

    cy.log('‚û°Ô∏è –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ —Å–∏—Å—Ç–µ–º—É');
    cy.hashVisit('/log_in');
    cy.get('[data-test="ui-testing-auth-page-login-input"]').type(username);
    cy.get('[data-test="ui-testing-auth-page-password-input"]').type(password);
    cy.get('[data-test="ui-testing-auth-page-submit-btn"]').click();

    cy.wait('@list');
    cy.location('hash').should('include', '#/transcripts');

    cy.log('‚û°Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π');
    cy.get('button[aria-label="Menu"]').click();
    cy.contains(fileB).should('be.visible');
    cy.contains(fileA).should('be.visible');

    cy.intercept('GET', `${apiUrl}/transcript?task_id=${taskA}*&limit=*`, {
      statusCode: 200,
      body: {
        page: 1, pages: 1, size: chunksA.length, total: chunksA.length,
        transcriptions: chunksA,
      },
    }).as('chunksA');

    cy.log('‚û°Ô∏è –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é A');
    cy.contains(fileA).click();
    cy.location('hash').should('include', `#/transcripts/${taskA}`);
    cy.wait('@chunksA');

    cy.log('‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏');
    cy.get('[data-test="ui-testing-transcript-chunk"]').filter(':has(p)').should('have.length', 2);
    cy.contains('–¢–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏').should('be.visible');
    cy.contains('–¢–µ–∫—Å—Ç –≤—Ç–æ—Ä–æ–π —á–∞—Å—Ç–∏.').should('be.visible');

    cy.log('‚û°Ô∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞–Ω–∫—É —á–µ—Ä–µ–∑ –∫–ª–∏–∫ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å-–º–µ—Ç–∫—É');
    cy.get('[rect-idx="1"]').click();

    cy.log('‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ –Ω–∞ —á–∞–Ω–∫ –ø—Ä–æ—à—ë–ª');
    cy.get(`#chunk-2`).should('be.visible');
  });
});
